name: Scraper Cron Job

on:
  schedule:
    # 11:00 UTC = 12:00 CET (Winter) / 13:00 CEST (Summer)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      league:
        description: 'League to scrape (optional, defaults to all)'
        required: false
        default: ''
      scope:
        description: 'Scrape Scope'
        required: true
        default: 'Last Round'
        type: choice
        options:
        - 'Last Round'
        - 'All Rounds'
      rescrape:
        description: 'Force Rescrape'
        required: false
        type: boolean
        default: false
      skip_analysis:
        description: 'Skip Gemini Analysis'
        required: false
        type: boolean
        default: true

jobs:
  scrape-leagues:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # We can run these in parallel or sequence. Parallel is faster.
        league: [eredivisie, laliga, serieb, seriea, bundesliga, ligue1, premier]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11' 

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
    
    - name: Run Scraper for ${{ matrix.league }}
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # If needed
      run: |
        # Construct arguments
        ARGS="${{ matrix.league }}"
        
        # --- Handle Inputs ---
        
        # Force Rescrape
        if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.rescrape }}" == "true" ]; then
          ARGS="$ARGS --force-rescrape"
        fi
        
        # Scope (Last Round vs All)
        # Default for cron schedule is Last Round.
        # For manual: check input.
        if [ "${{ github.event_name }}" == "schedule" ]; then
             # Cron always runs last round only
             ARGS="$ARGS --last-round"
        elif [ "${{ github.event.inputs.scope }}" == "Last Round" ]; then
             ARGS="$ARGS --last-round"
        fi
        
        # Skip Analysis
        # Default for cron is Skip Analysis.
        # For manual: check input.
        if [ "${{ github.event_name }}" == "schedule" ]; then
             ARGS="$ARGS --skip-analysis"
        elif [ "${{ github.event.inputs.skip_analysis }}" == "true" ]; then
             ARGS="$ARGS --skip-analysis"
        fi
        
        # Specific League Filter (Manual Only)
        INPUT_LEAGUE="${{ github.event.inputs.league }}"
        if [ -n "$INPUT_LEAGUE" ] && [ "$INPUT_LEAGUE" != "${{ matrix.league }}" ]; then
          echo "Skipping ${{ matrix.league }} because $INPUT_LEAGUE was requested."
          exit 0
        fi

        echo "Running scraper for $ARGS"
        python -m backend.scraper.main $ARGS
